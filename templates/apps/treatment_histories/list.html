{% extends "layouts/base.html" %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css">
{% load static %}

{% block extrastyle %}

<style>
  .fixed-width-aside {
      width: 100%;
      flex: none;
  }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="bg-gray-100 dark:bg-gray-900 p-4">
  <div class="flex flex-col md:flex-row">
    {% include "includes/batch.html" %}
    <section class="w-full md:w-3/4 md:p-6 flex flex-col rounded-lg">
      <main class="w-full">
    <!-- Navigation Bar -->
    <nav class="flex flex-wrap justify-center items-center bg-white dark:bg-gray-800 p-2 border-b border-gray-200 dark:border-gray-700 mb-4 rounded-lg">
      <a href="{% url 'daily_log_list' batch.id %}" class="border  border-blue-700 text-blue-700 px-4 py-2 m-2 rounded-lg hover:bg-blue-700 hover:text-white transition duration-300 flex items-center justify-center">
        DailyLog
      </a>
      <a href="{% url 'feeding_list' batch.id%}" class="border border-green-500 text-green-500 px-4 py-2 m-2 rounded-lg hover:bg-green-500 hover:text-white transition duration-300 flex items-center justify-center">
        Feeding
      </a>
      <a href="{% url 'egg_collection_list' batch.id %}" class="border   border-red-500 text-red-500 px-4 py-2 m-2 rounded-lg hover:bg-red-500 hover:text-white transition duration-300 flex items-center justify-center">
        EggCollection
      </a>
      <a href="{% url 'treatment_history_list' batch.id %}"   class="border  bg-yellow-500 border-yellow-500 text-white px-4 py-2 m-2 rounded-lg hover:bg-yellow-500 hover:text-white transition duration-300 flex items-center justify-center">
        TreatmentHistory
      </a>
      <a href="{% url 'batch_allocation_list' batch.id %}" 
            class="border border-purple-500 text-purple-500 px-4 py-2 m-2 rounded-lg  hover:bg-purple-500 hover:text-white transition duration-300 flex items-center justify-center">
              Sales
          </a>
    </nav>

    <div class="p-4 bg-white dark:bg-gray-800 block sm:flex items-center justify-between border-b border-gray-200 dark:border-gray-700 lg:mt-1.5 rounded-lg">
       <div class="items-center justify-between block sm:flex md:divide-x md:divide-gray-100 dark:divide-gray-700">
          <div class="flex flex-row items-center mb-4 sm:mb-0">
            <form class="flex sm:pr-3" method="GET">
              <label for="treatment_histories-search" class="sr-only">search</label>
              <div class="relative w-48 mt-1 sm:w-64 xl:w-96">
                <input type="date" name="q" id="treatment_histories-search" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Insert the date">
              </div>
              <button type="submit" class="flex items-center px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded-lg m-2 transition duration-300">
                <svg class="w-6 h-6 " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                  <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"/>
                </svg>
                Search
            </button>
            </form>
          </div>
          <div class="flex flex-wrap justify-center items-center bg-white dark:bg-gray-800 p-4 dark:border-gray-700 mb-4 rounded-lg">
            <button id="bulk-delete-drawer" class="flex items-center px-4 py-2 bg-red-600 hover:bg-red-800 text-white rounded-lg m-2 transition duration-300" data-drawer-target="drawer-bulk-delete" data-drawer-show="drawer-bulk-delete" aria-controls="drawer-bulk-delete" data-drawer-placement="right">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              Delete
            </button>
            <a href="{% url 'treatment_history_list_print' batch.id %}" class="flex items-center px-4 py-2 bg-yellow-700 hover:bg-yellow-800 text-white rounded-lg m-2 transition duration-300">
              <svg class="w-6 h-6 " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd" d="M8 3a2 2 0 0 0-2 2v3h12V5a2 2 0 0 0-2-2H8Zm-3 7a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h1v-4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v4h1a2 2 0 0 0 2-2v-5a2 2 0 0 0-2-2H5Zm4 11a1 1 0 0 1-1-1v-4h8v4a1 1 0 0 1-1 1H9Z" clip-rule="evenodd"/>
              </svg>
              Print
            </a>
            <a href="{% url 'treatment_history_list_export' batch.id %}" class="flex items-center px-4 py-2 bg-green-700 hover:bg-green-800 text-white rounded-lg m-2 transition duration-300">
              <svg class="w-6 h-6 text-white dark:text-gray-800" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 3v4a1 1 0 0 1-1 1H5m4 6 2 2 4-4m4-8v16a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V7.914a1 1 0 0 1 .293-.707l3.914-3.914A1 1 0 0 1 9.914 3H18a1 1 0 0 1 1 1Z"/>
              </svg>
              Export to Excel
            </a>

            <button id="createTreatmentHistoryButton" class=" flex text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-primary-800 m-2 transition duration-300" type="button" data-drawer-target="drawer-create-treatmenthistory-default" data-drawer-show="drawer-create-treatmenthistory-default" aria-controls="drawer-create-treatmenthistory-default" data-drawer-placement="right">
              <svg class="w-6 h-6 " aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
              </svg>
              Create a New
            </button>
          </div>
        </div>
    </div>
    <div class="flex flex-col">
      <div class="overflow-x-auto">
        <div class="inline-block min-w-full align-middle">
          <div class="overflow-hidden shadow rounded-lg">
            <table class="min-w-full divide-y divide-gray-200 table-fixed dark:divide-gray-600">
              <thead class="bg-gray-100 dark:bg-gray-700">
                <tr>
                  <th scope="col" class="p-4">
                    <div class="flex items-center">
                      <input id="checkbox-all" aria-describedby="checkbox-1" type="checkbox" class="w-4 h-4 border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-primary-300 dark:focus:ring-primary-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600" onclick="toggleCheckboxes(this)">
                      <label for="checkbox-all" class="sr-only">Select All</label>
                    </div>
                  </th>
                  <th scope="col" class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                    Date
                  </th>
                  <th scope="col" class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                    Treatment
                  </th>
                  <th scope="col" class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                    Details
                  </th>
                  <th scope="col" class="p-4 text-xs font-medium text-left text-gray-500 uppercase dark:text-gray-400">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                {% for date, histories in grouped_histories %}
                <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                  <td class="p-4" colspan="5">
                    <strong class="text-gray-900 whitespace-nowrap dark:text-white">{{ date }}</strong>
                  </td>
                </tr>
                {% for history in histories %}
                <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                  <td class="w-4 p-4">
                    <div class="flex items-center">
                      <input id="checkbox-{{ history.id }}" value="{{ history.id }}" type="checkbox" class="checkbox-item w-4 h-4 border-gray-300 rounded bg-gray-50 focus:ring-3 focus:ring-primary-300 dark:focus:ring-primary-600 dark:ring-offset-gray-800 dark:bg-gray-700 dark:border-gray-600">
                      <label for="checkbox-{{ history.id }}" class="sr-only">checkbox</label>
                    </div>
                  </td>
                  <td class="p-4 text-sm font-normal text-gray-500 whitespace-nowrap dark:text-gray-400">
                    {{ history.treatment_date }}
                  </td>
                  <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                    <a href="{% url 'treatment_list'%}?q={{ history.treatment.name }}">
                    {{ history.treatment.name }}
                  </a>
                  </td>
                  <td class="p-4 text-base font-medium text-gray-900 whitespace-nowrap dark:text-white">
                    {{ history.details }}
                  </td>
                  <td class="p-4 space-x-2 whitespace-nowrap">
                    <button type="button" id="updateTreatmentHistoryButton-{{ history.id }}" data-drawer-target="drawer-update-treatmenthistory-default{{ history.id }}" data-drawer-show="drawer-update-treatmenthistory-default{{ history.id }}" aria-controls="drawer-update-treatmenthistory-default{{ history.id }}" data-drawer-placement="right" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white rounded-lg bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-primary-300 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-primary-800 transition duration-300">
                      <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path>
                        <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 012 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                      </svg>
                      Update
                    </button>
                    <button type="button" id="deleteTreatmentHistoryButton-{{ history.id }}" data-drawer-target="drawer-delete-treatmenthistory-default{{ history.id }}" data-drawer-show="drawer-delete-treatmenthistory-default{{ history.id }}" aria-controls="drawer-delete-treatmenthistory-default{{ history.id }}" data-drawer-placement="right" class="inline-flex items-center px-3 py-2 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-800 focus:ring-4 focus:ring-red-300 dark:focus:ring-red-900 transition duration-300">
                      <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                      </svg>
                      Delete
                    </button>
                  </td>
                </tr>
                <!-- Bulk Delete TreatmentHistories Drawer -->
                <div id="drawer-bulk-delete" class="fixed top-0 right-0 z-40 w-full h-screen max-w-xs p-4 overflow-y-auto transition-transform translate-x-full bg-white dark:bg-gray-800 rounded-lg" tabindex="-1" aria-labelledby="drawer-label" aria-hidden="true">
                  <h5 id="drawer-label" class="inline-flex items-center text-sm font-semibold text-gray-500 uppercase dark:text-gray-400">Delete Selected Items</h5>
                  <button type="button" id="close-drawer-bulk" aria-controls="drawer-bulk-delete" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 absolute top-2.5 right-2.5 inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white transition duration-300">
                    <svg aria-hidden="true" class="w-5 h-5 text-gray-400 hover:text-gray-900 dark:hover:text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Close menu</span>
                  </button>
                  <svg class="w-10 h-10 mt-8 mb-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <h3 class="mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete the selected treatment histories?</h3>
                  <a id="bulk-delete" href="#" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-900 transition duration-300">Yes, I'm sure</a>
                  <a href="#" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-sm px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700 transition duration-300">No, cancel</a>
                </div>
                <!-- Delete TreatmentHistory Drawer -->
                <div id="drawer-delete-treatmenthistory-default{{ history.id }}" class="fixed top-0 right-0 z-40 w-full h-screen max-w-xs p-4 overflow-y-auto transition-transform translate-x-full bg-white dark:bg-gray-800 rounded-lg" tabindex="-1" aria-labelledby="drawer-label" aria-hidden="true">
                  <h5 id="drawer-label" class="inline-flex items-center text-sm font-semibold text-gray-500 uppercase dark:text-gray-400">Delete item</h5>
                  <button type="button" data-drawer-dismiss="drawer-delete-treatmenthistory-default{{ history.id }}" aria-controls="drawer-delete-treatmenthistory-default{{ history.id }}" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 absolute top-2.5 right-2.5 inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white transition duration-300">
                    <svg aria-hidden="true" class="w-5 h-5 text-gray-400 hover:text-gray-900 dark:hover:text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Close menu</span>
                  </button>
                  <svg class="w-10 h-10 mt-8 mb-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <h3 class="mb-6 text-lg text-gray-500 dark:text-gray-400">Are you sure you want to delete this treatment history?</h3>
                  <a href="{% url 'delete_treatment_history' history.id %}" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-3 py-2.5 text-center mr-2 dark:focus:ring-red-900 transition duration-300">Yes, I'm sure</a>
                  <a href="#" class="text-gray-900 bg-white hover:bg-gray-100 focus:ring-4 focus:ring-primary-300 border border-gray-200 font-medium inline-flex items-center rounded-lg text-sm px-3 py-2.5 text-center dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700 transition duration-300">No, cancel</a>
                </div>
                <!-- Edit TreatmentHistory Drawer -->
                <div id="drawer-update-treatmenthistory-default{{ history.id }}" class="fixed top-0 right-0 z-40 w-full h-screen max-w-xs p-4 overflow-y-auto transition-transform translate-x-full bg-white dark:bg-gray-800 rounded-lg" tabindex="-1" aria-labelledby="drawer-label" aria-hidden="true">
                  <h5 id="drawer-label" class="inline-flex items-center mb-6 text-sm font-semibold text-gray-500 uppercase dark:text-gray-400">Update TreatmentHistory</h5>
                  <button type="button" data-drawer-dismiss="drawer-update-treatmenthistory-default{{ history.id }}" aria-controls="drawer-update-treatmenthistory-default{{ history.id }}" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 absolute top-2.5 right-2.5 inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white transition duration-300">
                    <svg aria-hidden="true" class="w-5 h-5 text-gray-400 hover:text-gray-900 dark:hover:text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="sr-only">Close menu</span>
                  </button>
                  <!-- Update TreatmentHistory Form -->
                  <form method="post" enctype="multipart/form-data" action="{% url 'update_treatment_history' history.id %}">
                    {% csrf_token %}
                    <div class="space-y-4">
                      <!-- Treatment Date Field -->
                      <div>
                        <label for="treatment_date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Treatment Date</label>
                        <input type="date" name="treatment_date" id="treatment_date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500 transition duration-300" value="{{ history.treatment_date }}" required>
                      </div>
                      <!-- Treatment Field -->
                      <div>
                        <label for="treatment" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Treatment</label>
                        <select name="treatment" id="treatment" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500 transition duration-300" required>
                          {% for treatment in treatments %}
                          <option value="{{ treatment.id }}" {% if treatment.id == history.treatment.id %}selected{% endif %}>{{ treatment.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <!-- Comment Field -->
                      <div>
                        <label for="details" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Details</label>
                        <textarea id="details" rows="4" name="details" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500 transition duration-300" placeholder="Enter comments here">{{ history.details }}</textarea>
                      </div>
                    </div>
                    <!-- Form Actions -->
                    <div class="mt-4 flex justify-between">
                      <button type="submit" class="w-full justify-center text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-primary-800 transition duration-300">Update</button>
                      <a href="{% url 'update_treatment_history' history.id %}" class="w-full justify-center text-red-600 inline-flex items-center hover:text-white border border-red-600 hover:bg-red-600 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:border-red-500 dark:text-red-500 dark:hover:text-white dark:hover:bg-red-600 dark:focus:ring-red-900 transition duration-300">Delete</a>
                    </div>
                  </form>
                </div>
                {% endfor %}
                {% endfor %}
              </tbody>
            </table>
            <div class="flex items-center justify-center space-x-4 mt-4">
              {% if grouped_histories.has_previous %}
                  <a href="?page={{ grouped_histories.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
                     class="px-4 py-2 text-sm font-medium text-gray-900 bg-gray-200 rounded-lg hover:bg-gray-300 dark:text-white dark:bg-gray-700 dark:hover:bg-gray-600 transition duration-300">
                    Previous
                  </a>
              {% endif %}

              <span class="text-sm font-medium text-gray-900 dark:text-white">
                  Page {{ grouped_histories.number }} of {{ grouped_histories.paginator.num_pages }}
              </span>

              {% if grouped_histories.paginator.num_pages > 10 %}
                  <!-- Afficher les liens vers les 10 dernières pages -->
                  <div class="flex space-x-2">
                      {% for page_num in grouped_histories.paginator.page_range|slice:":10" %}
                          <a href="?page={{ page_num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
                             class="px-3 py-1 text-sm font-medium text-gray-900 bg-gray-200 rounded-lg hover:bg-gray-300 dark:text-white dark:bg-gray-700 dark:hover:bg-gray-600 transition duration-300">
                              {{ page_num }}
                          </a>
                      {% endfor %}
                  </div>
              {% endif %}

              {% if grouped_histories.has_next %}
                  <a href="?page={{ grouped_histories.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}"
                     class="px-4 py-2 text-sm font-medium text-gray-900 bg-gray-200 rounded-lg hover:bg-gray-300 dark:text-white dark:bg-gray-700 dark:hover:bg-gray-600 transition duration-300">
                    Next
                  </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Add TreatmentHistory Drawer -->
      <!-- Notification d'erreur, placée en dehors du drawer, en haut de la page -->
{% if form.errors %}
<div id="error-notification" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg mb-4 opacity-100 transition-all duration-500 z-50">
  <p>There are some errors in the form. Please check the fields highlighted below.</p>
</div>
<script>
  setTimeout(function() {
    document.getElementById('error-notification').style.opacity = 0;
    setTimeout(function() {
      document.getElementById('error-notification').style.display = 'none';
    }, 500); // Delay before hiding completely
  }, 5000); // Hide after 5 seconds
</script>
{% endif %}

<!-- Drawer code -->
<div id="drawer-create-treatmenthistory-default"
     class="fixed top-0 right-0 z-40 w-full h-screen max-w-xs p-4 overflow-y-auto transition-transform translate-x-full bg-white dark:bg-gray-800 rounded-lg"
     tabindex="-1" aria-labelledby="drawer-label" aria-hidden="true">

  <h5 id="drawer-label" class="inline-flex items-center mb-6 text-sm font-semibold text-gray-500 uppercase dark:text-gray-400">New TreatmentHistory</h5>

  <button type="button"
          {% if not form.errors %}data-drawer-dismiss="drawer-create-treatmenthistory-default"{% endif %}
          aria-controls="drawer-create-treatmenthistory-default"
          class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 absolute top-2.5 right-2.5 inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white transition duration-300">
    <svg aria-hidden="true" class="w-5 h-5 text-gray-400 hover:text-gray-900 dark:hover:text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
    </svg>
    <span class="sr-only">Close menu</span>
  </button>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="space-y-4">

      <!-- Erreurs générales -->
      {% if form.non_field_errors %}
      <div class="text-sm text-red-600 dark:text-red-400">
        {% for error in form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}

      <!-- Champs et erreurs spécifiques -->
      {% for field in form %}
      <div class="{% if field.errors %}border border-red-500{% endif %}">
        <label for="{{ field.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}
        <div class="mt-1 text-sm text-red-600 dark:text-red-400">
          {% for error in field.errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endfor %}

      <div class="mt-4 flex justify-between">
        <button type="submit"
                class="text-white w-full justify-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-primary-800 transition duration-300">
          Add TreatmentHistory
        </button>

        <!-- Le bouton Cancel ferme le drawer sans conditions -->
        <button type="button"
                {% if not form.errors %}data-drawer-dismiss="drawer-create-treatmenthistory-default"{% endif %}
                aria-controls="drawer-create-treatmenthistory-default"
                class="inline-flex w-full justify-center text-gray-500 items-center bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-primary-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600 transition duration-300">
          <svg aria-hidden="true" class="w-5 h-5 -ml-1 sm:mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Cancel
        </button>
      </div>
    </div>
  </form>
</div>

  </main>

    </section>
  </div>
</div>

<script>
  function toggleCheckboxes(masterCheckbox) {
    const checkboxes = document.querySelectorAll('.checkbox-item');
    checkboxes.forEach(checkbox => {
      checkbox.checked = masterCheckbox.checked;
    });
  }

  function getCheckedIds() {
    const checkedCheckboxes = document.querySelectorAll('.checkbox-item:checked');
    const ids = Array.from(checkedCheckboxes).map(checkbox => checkbox.value);
    return ids; // Retourne les IDs au lieu de les afficher dans la console
  }

  document.getElementById('bulk-delete').addEventListener('click', function() {
    const treatmenthistoryIds = getCheckedIds();
    if (treatmenthistoryIds.length === 0) {
      return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url = "{% url 'bulk_delete_treatment_histories' %}";

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ treatment_history_ids: treatmenthistoryIds, action: 'delete' })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        location.reload(); // Recharge la page pour mettre à jour la liste des bâtiments
      } else {
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      alert('Une erreur est survenue lors de la suppression des batches.');
    });
  });

</script>

{% endblock content %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
<script src="https://cdn.tailwindcss.com/3.3.3"></script>

{% endblock extra_js %}
